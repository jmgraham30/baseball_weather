---
title: "Open-Air Baseball Parks"
subtitle: "The Impacts of Weather Conditions"
author: "Jason M. Graham"
institute: "University of Scranton"
format: 
  html:
    code-fold: true
    echo: true
    toc: true
    toc-location: left
bibliography: report_bib.bib
---

```{r}
#| echo: false
#| include: false

# load packages
library(tidyverse) # wrangling, plots etc.
library(GGally) # paired plots
library(skimr) # data summary
library(knitr) # for table formatting
library(kableExtra) # for extra table formatting 
library(patchwork) # for combining plots
library(RColorBrewer) # for plot colors

# set plot theme
theme_set(theme_minimal(base_size = 12))

venues_html <- "https://raw.githubusercontent.com/jmgraham30/baseball_weather/main/data/USProSportsVenues.csv"

bos_game_weather_html <- "https://raw.githubusercontent.com/jmgraham30/baseball_weather/main/data/boston_game_weather.csv"

```


```{r}
#| message: false

# load weather and game data for Boston 
boston_game_weather <- read_csv(bos_game_weather_html)
# create separate columns with day, month, and year corresponding
# to game dates; and create a binary win (1) or not (0) column
boston_game_weather <- boston_game_weather %>%
  mutate(year=year(date),
         month=month(date),
         day=day(date),
         wl_binary=ifelse(wl=="W",1,0))
# load sports venue data
pro_sports_venues <- read_csv(venues_html)
# extract baseball parks
baseball_parks <- pro_sports_venues %>%
  filter(Sport == "MLB")

# add info about open roof
baseball_parks$Open_Roof <- c("No",rep("Yes",9),
                              "No","Yes","Yes","Yes",
                              "No","No",
                              rep("Yes",7),"No","Yes",
                              "Yes","No","No","No","Yes")

# load map data for US states minus AK and HI
states_df <- map_data("state") %>%
  filter(region != "alaska" | region != "hawaii")
```

## Executive Summary


## Background

[Major League Baseball](https://en.wikipedia.org/wiki/Major_League_Baseball) (MLB) is a professional athletics organization made up 30 baseball teams, 29 in the United States and one in Canada, [view MLB homepage](https://www.mlb.com/). Each of the thirty Major League Baseball teams plays in one of thirty stadiums or baseball parks [@wikipediaListCurrent]. A list of the thirty MLB stadiums can be found on Wikipedia, [go to Wikipedia article on MLB stadiums](https://en.wikipedia.org/wiki/List_of_current_Major_League_Baseball_stadiums). Of the thirty MLB baseball stadiums, 22 of them are open-air. [^1] @fig-parks shows a map of the MLB stadiums and uses color to designate the open-air status of each of the stadiums. 

[^1]: By "open-air" we mean permanently open with no option for roof cover. Stadiums with either a fixed or retractable roof are not considered to be open-air for our purposes. 

```{r}
#| label: fig-parks
#| fig-cap: The 30 MLB park locations and their open-air status. Darker shading indicates overlap of nearby parks. 
#| fig-alt: A plot showing the location of each of the 30 MLB stadiums by its latitude and longitude overlayed on a map of the 48 continental United States. Colors are used to distinguish the open-air status of each of the stadiums, 22 of the 30 stadiums are designated as open-air.

ggplot() +
  geom_polygon(data=states_df,
               aes(long,lat,group=group),
               fill="white",color="darkgrey") + 
  geom_point(data=baseball_parks,aes(x=Longitude,y=Latitude,color=Open_Roof),
             size=2.5,alpha=0.6) +
  scale_color_manual(values=c("orange","#512d6d")) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5)) + 
  xlab("") + ylab("") + ggtitle("Major League Baseball Parks")
```

### Initial Research Question

We would like to know about the impact that climate or weather may have on MLB teams that play in open-air stadiums. Given that climate and weather patterns are changing and impacting many aspects of our society and lives, and given that many MLB parks are exposed to the elements for many months of the year, it could be that changing climate and weather conditions may impact MLB. **In particular, we would like to know if changing climate and weather patterns might have an effect on either team performance or game attendance.**

### Approach to Research

In order to address our initial research question, we will take as a case study the open-air stadium [Fenway Park](https://en.wikipedia.org/wiki/Fenway_Park), home of the [Boston Red Sox](https://en.wikipedia.org/wiki/Boston_Red_Sox), [view Red Sox homepage](https://www.mlb.com/redsox). Fenway park in located in Boston, Massachusetts (42°20′46.5″N 71°5′51.9″W) and is the oldest MLB park, open since 1912 [@wikipediaFenwayPark], [see the Fenway homepage](https://www.mlb.com/redsox/ballpark). @fig-fenway shows a view of Fenway Park, image from [@ticketmasterStepInside]. @fig-parks-fenway shows the same map of MLB stadiums as @fig-parks but with Fenway Park highlighted. 


![Feway Park, image from [@ticketmasterStepInside]](https://blog.ticketmaster.com/wp-content/uploads/Fenway-Park-field.jpg){#fig-fenway width=70%}



```{r}
#| label: fig-parks-fenway
#| fig-cap: MLB park locations and open-air status with Fenway Park in Boston, MA highlighted.

ggplot() +
  geom_polygon(data=states_df,
               aes(long,lat,group=group),
               fill="white",color="darkgrey") + 
  geom_point(data=baseball_parks,aes(x=Longitude,y=Latitude,color=Open_Roof),
             size=2.5,alpha=0.6) +
  geom_point(data=baseball_parks %>% filter(Abbreviation == "BOS"),
                                            aes(x=Longitude,y=Latitude),size=5,color="#512d6d") + 
  geom_label( 
    data=baseball_parks %>% filter(Abbreviation == "BOS"), # Filter data first
    aes(label="Fenway",x=-71,y=43.6),color = "black",
    fill="red") + 
  scale_color_manual(values=c("orange","#512d6d")) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5)) + 
  xlab("") + ylab("") + ggtitle("Major League Baseball Parks (Fenway Highlighted)")
```

The main part of this project combines data about home games played at Fenway Park with historical Boston area weather data in an attempt to assess if changing climate and weather conditions have impacted either team performance or game attendance at Fenway, with Fenway serving as an example of an open-air baseball stadium. 

## Data Collection and Documentation

To address our primary question, we collected and combined two sets of data. The first data set collected contains information about each home game played by the Boston Red Sox at Fenway Park. The second data set collected contains weather data such as in Boston over the available time frame of games at Fenway.    

### Team Data

To obtain the data on home games played by the Boston Red Sox at Fenway Park, we used the function `get_retrosheet` from the R package `retrosheet` to download game data for a specific year and team [@retrosheet_cite]. Then, we used a function `team_games` to iterate over all the years that the Red Sox played at Fenway Park, that is, 1912 - 2022 (skipping 2020 due to the COVID-19 pandemic). The code to accomplish this is in the [`team_home.R`](https://github.com/jmgraham30/baseball_weather/blob/main/R/team_home.R) script available at our baseball_weather GitHub repository, [view the GitHub repo](https://github.com/jmgraham30/baseball_weather). 


The `retrosheet` package contains a collection of tools to import and structure the single-season event, game-log, roster, and schedule data available from the [Retrosheet website](https://www.retrosheet.org) which maintains play-by-play accounts of as many major league games as possible. The Retrosheet data we downloaded for the Boston Red Sox has a structure indicated by @tbl-boston-data.

```{r}
#| message: false
#| label: tbl-boston-data
#| tbl-cap: A few rows of the Retrosheet data downloaded for the Boston Red Sox home games at Fenway Park.

bos_home_games_url <- "https://raw.githubusercontent.com/jmgraham30/baseball_weather/main/data/boston_home.csv"

bos_home_games <- read_csv(bos_home_games_url)

bos_home_games %>%
  head(5) %>%
  kable()

```


Each row corresponds to a single home game at Fenway. The columns of the data set specify for each game the date, whether the game is a double-header, the number of runs scored by the home team (Boston), the number of runs scored by the visiting team, the game attendance, the duration of the game in minutes, the difference between the home team score and the visiting team score, and whether Boston won (W) or did not win (NW). 

The data set contains 8,634 rows or observations. 

### Weather Data

We used R package [`RNCEP`](https://sites.google.com/site/michaelukemp/rncep) to download climate and weather data for the Boston area [@rncep_cite]. This package simplifies the access, organization, and visualization of weather data from the [NCEP/NCAR reanalysis](https://psl.noaa.gov/data/gridded/data.ncep.reanalysis.html) and [NCEP/DOE reanalysis II](https://psl.noaa.gov/data/gridded/data.ncep.reanalysis2.html) data sets. Specifically, we used the function `NCEP.gather.surface` to download data for the surface temperature (`air.sig995`), precipitation (`rhum.sig995`), and humidity (`pr_wtr.eatm`). See the documentation for `RNCEP` for more details and specifications of units used.  The climate and weather data we downloaded for Boston has a structure indicated by @tbl-boston-weather.

```{r}
#| message: false
#| label: tbl-boston-weather
#| tbl-cap: A few rows of the climate and weather data downloaded for Boston.

bos_weather_url <- "https://raw.githubusercontent.com/jmgraham30/baseball_weather/main/data/boston_weather_df.csv"

bos_weather <- read_csv(bos_weather_url)

bos_weather %>%
  head(5) %>%
  kable()

```

The data set contains 15,622 rows or observations. Note that the temperature, humidity, and precipitation values recorded are averaged daily and over a spatial region (between 41 and 42 degrees latitude and 289 and 290 degrees longitude). The code used to download the data is contained in the [`boston_weather_get.R`](https://github.com/jmgraham30/baseball_weather/blob/main/R/boston_weather_get.R) script available our baseball_weather GitHub repository, [view the GitHub repo](https://github.com/jmgraham30/baseball_weather).

### Combined Weather and Game Data

In order to address our initial research question, we combined the Boston weather and home game data. It is important to emphasize the following:

- Climate and weather data is only available starting in the 1950's while Boston Red Sox home grame data goes back to 1912. Thus, we must restrict the home game data to those observations starting in the 1950's.

- The downloaded climate and weather data contains observations for many more days than just the days on which there were Red Sox home games. Thus, we must extract those climate and weather observatios corresponding to dates of games at Fenway.  

All the necessary data manipulations were accomplished through functions from the `dplyr` package [@dplyr_cite]. See the [`boston_data_wrangling.R`](https://github.com/jmgraham30/baseball_weather/blob/main/R/boston_data_wrangling.R) script available our baseball_weather GitHub repository, [view the GitHub repo](https://github.com/jmgraham30/baseball_weather).


The combined weather game data for the Boston Red Sox home games at Fenway Park has a structure indicated by @tbl-boston-game-weather.

```{r}
#| message: false
#| label: tbl-boston-game-weather
#| tbl-cap: A few rows of the weather and game data for the Boston Red Sox home games at Fenway Park.

boston_game_weather %>%
  head(5) %>%
  kable()

```

This is our principal data set and it contains 5,727 rows.

## Exploratory Results

The script [`boston_home_weather_eda.R`](https://github.com/jmgraham30/baseball_weather/blob/main/R/boston_home_weather_eda.R) contains the full exploratory analysis and all corresponding code.

### Potential Response Variables

@fig-rep1-edas shows the distributions of runs scored by the Red Sox and the visiting team, as well as the number of games and the difference in scores between the Red Sox and visiting teams. The median number of runs for Boston is 5 while the median number of runs for visitors is 4. 

```{r}
#| message: false
#| label: fig-rep1-edas
#| fig-cap: Exploratory plots for the distributions of Red Sox runs, visitor runs, score difference, and wins for  Red Sox home games played at Fenway Park from 1950 to 2022 (excluding 2020).

ra_1 <- boston_game_weather %>%
  ggplot(aes(x=hm_runs)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  xlab("Number of Runs by Boston") + 
  ylab("Count")
# Number of visitor runs
ra_2 <- boston_game_weather %>%
  ggplot(aes(x=vis_runs)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  xlab("Number of Runs by Visitors") + 
  ylab("Count")
# Boston runs - Visitor runs
ra_3 <- boston_game_weather %>%
  ggplot(aes(x=score_diff,fill=wl)) + 
  geom_histogram(color="#512d6d") + 
  scale_fill_manual(values = c("#E69F00","#009E73")) + 
  labs(x = "Boston Runs - Visitor Runs",
       y = "Count",
       fill="Win/Not")
# Win or Not Win
ra_4 <- boston_game_weather %>%
  ggplot(aes(x=wl,fill=wl)) + 
  geom_bar(color="#512d6d") + 
  scale_fill_manual(values = c("#E69F00","#009E73")) + 
  theme(legend.position = "none") +
  labs(x = "No Win or Win",
       y = "Count")

(ra_1 + ra_2) / (ra_4 + ra_3)
```

We observe from @fig-rep1-edas that the Red Sox have won more games than they have lost and tend to win by a median of one run. 


@fig-rep2-edas displays the distributions for the duration and attendance of Red Sox home games played at Fenway Park from 1950 to 2022 (excluding 2020). The median duration for a game is 170 minutes while the median attendance is around thirty thousand. Note that Fenway Park currently seats over 37,000 [@wikipediaFenwayPark]. 

```{r}
#| message: false
#| label: fig-rep2-edas
#| fig-cap: Exploratory plots for the distributions of game duration and attendance and Red Sox home games played at Fenway Park from 1950 to 2022 (excluding 2020).

rb_1 <- boston_game_weather %>%
  ggplot(aes(x=duration)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  labs(x = "Game Duration",
       y = "Count")
# Game attendances
rb_2 <- boston_game_weather %>%
  ggplot(aes(x=attendance)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  labs(x = "Game Attendance",
       y = "Count")

(rb_1 + rb_2)
```


One potentially important observation based on @fig-rep2-edas is that there are some Red Sox home games for which the recorded attendance is 0. Specifically, there are 243 such games. This value is determined using the following code:

```{r}
boston_game_weather %>%
  filter(attendance == 0) %>%
  nrow()
```


```{r}
#| message: false
#| label: fig-zero-attends
#| fig-cap: The number of Red Sox home games by year with a recorded attendance of zero.

boston_game_weather %>%
  filter(attendance == 0) %>%
  ggplot(aes(x=year)) + 
  geom_bar(color="#512d6d",fill="lightblue") + 
  labs(x="Year",y="Count",title="Observations with Zero Recorded Attendance")
```

It's not immediately clear why there may be a zero recorded for attendance at some games. This could be an error but further investigation is required to determine for certain. It might be necessary to remove those observations with zero attendance depending on what specific questions we decide to address with models. 

### Potential Predictor Variables

Our main interest in this project is to examine how climate and weather factors impact aspects of baseball games such as the score, outcome, duration, and attendance games. As previously noted, we have data about humidity, precipitable water[^2], and temperature for the Red Sox home games.

[^2]: Precipitable water is the amount of water potentially available in the atmosphere for precipitation, usually measured in a vertical column that extends from the Earth's surface to the upper edge of the troposphere.

#### Climate and Weather Variables

@fig-weathers show the distributions for humidity (as a percent), temperature (in degrees Fahrenheit), and precipitable water (in units of $\frac{\text{kg}}{\text{m}^2}$). 

```{r}
#| message: false
#| label: fig-weathers
#| fig-cap: Exploratory plots for the climate and weather variables on dates of Red Sox home games played at Fenway Park from 1950 to 2022 (excluding 2020).

w_1 <- boston_game_weather %>%
  ggplot(aes(x=humid)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  labs(x = "Humidity",
       y = "Count")

w_2 <- boston_game_weather %>%
  ggplot(aes(x=tempF)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  labs(x = "Temperature",
       y = "Count")

w_3 <- boston_game_weather %>%
  ggplot(aes(x=precip)) + 
  geom_histogram(color="#512d6d",fill="lightblue") + 
  labs(x = "Precipitation",
       y = "Count")

(w_1 + w_2 + w_3)
```

We see that the median temperature is about 65 degrees Fahrenheit, the median humidity is about 83 percent, and the median precipitable water is about 25 $\frac{\text{kg}}{\text{m}^2}$. 

### Variable Relationships

We would like to determine what if any impact there has been on the score, outcome, duration, or attendance of Red Sox games over time by temperature, humidity, or precipitable water.

@fig-runs shows the number of runs scored by the Boston Red Sox at each home game from 1950 to 2022 (2020 excluded) plotted against date, temperature, humidity, and precipitable water, respectively.

```{r}
#| message: false
#| label: fig-runs
#| fig-cap: The number of runs scored by Red Sox at home games at Fenway Park plotted against the game date, and climate and weather variables.


hs_date <- boston_game_weather %>%
  ggplot(aes(x=date,y=hm_runs)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Date",y="Red Sox Runs")
hs_temp <- boston_game_weather %>%
  ggplot(aes(x=tempF,y=hm_runs)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Temperature (F)",y="Red Sox Runs")
hs_humid <- boston_game_weather %>%
  ggplot(aes(x=humid,y=hm_runs)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Humidity",y="Red Sox Runs")
hs_precip <- boston_game_weather %>%
  ggplot(aes(x=precip,y=hm_runs)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Precipitable Water",y="Red Sox Runs")

(hs_date + hs_temp) / (hs_humid + hs_precip)
```

Here it is difficult to see any clear pattern of influence that date, temperature, humidity, or precipitable water have on the number of runs the Red Sox score at home games over the specified period of time.  We observe that there are potential outliers in each of the plots in @fig-runs.

@fig-wins shows shows the wins for the Boston Red Sox at each home game from 1950 to 2022 (2020 excluded) plotted against date, temperature, humidity, and precipitable water, respectively.

```{r}
#| message: false
#| label: fig-wins
#| fig-cap: The wins by Red Sox at home games at Fenway Park plotted against the game date, and climate and weather variables.


ws_date <- boston_game_weather %>%
  ggplot(aes(x=date,y=wl,color=wl)) + 
  geom_point(size=2,alpha=0.2) + 
  scale_color_manual(values = c("#E69F00","#009E73")) + 
  theme(legend.position = "none") + 
  labs(x="Date",y="Win/Not")
ws_temp <- boston_game_weather %>%
  ggplot(aes(x=tempF,y=wl,color=wl)) + 
  geom_point(size=2,alpha=0.2) + 
  scale_color_manual(values = c("#E69F00","#009E73")) +
  labs(x="Temperature (F)",y="Win/Not", color="Win/Not")
ws_humid <- boston_game_weather %>%
  ggplot(aes(x=humid,y=wl,color=wl)) + 
  geom_point(size=2,alpha=0.2) + 
  scale_color_manual(values = c("#E69F00","#009E73")) +
  theme(legend.position = "none") +
  labs(x="Humidity",y="Win/Not")
ws_precip <- boston_game_weather %>%
  ggplot(aes(x=precip,y=wl,color=wl)) + 
  geom_point(size=2,alpha=0.2) + 
  scale_color_manual(values = c("#E69F00","#009E73")) +
  theme(legend.position = "none") +
  labs(x="Precipitable Water",y="Win/Not")

(ws_date + ws_temp) / (ws_humid + ws_precip)
```


@fig-duration shows ... 

```{r}
#| message: false
#| label: fig-duration
#| fig-cap: The game duration for Red Sox  home games at Fenway Park plotted against the game date, and climate and weather variables.


ds_date <- boston_game_weather %>%
  ggplot(aes(x=date,y=duration)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Date",y="Game Duration")
ds_temp <- boston_game_weather %>%
  ggplot(aes(x=tempF,y=duration)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Temperature (F)",y="Game Duration")
ds_humid <- boston_game_weather %>%
  ggplot(aes(x=humid,y=duration)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Humidity",y="Game Duration")
ds_precip <- boston_game_weather %>%
  ggplot(aes(x=precip,y=duration)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Precipitable Water",y="Game Duration")

(ds_date + ds_temp) / (ds_humid + ds_precip)
```


@fig-attend shows ... 

```{r}
#| message: false
#| label: fig-attend
#| fig-cap: The game attendance for Red Sox  home games at Fenway Park plotted against the game date, and climate and weather variables.


as_date <- boston_game_weather %>%
  filter(attendance > 0) %>%
  ggplot(aes(x=date,y=attendance)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Date",y="Game Attendance")
as_temp <- boston_game_weather %>%
  filter(attendance > 0) %>%
  ggplot(aes(x=tempF,y=attendance)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Temperature (F)",y="Game Attendance")
as_humid <- boston_game_weather %>%
  filter(attendance > 0) %>%
  ggplot(aes(x=humid,y=attendance)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Humidity",y="Game Attendance")
as_precip <- boston_game_weather %>%
  filter(attendance > 0) %>%
  ggplot(aes(x=precip,y=attendance)) + 
  geom_point(size=2,color="lightblue",alpha=0.5) + 
  geom_smooth(color="#512d6d",fill="darkgreen") + 
  labs(x="Precipitable Water",y="Game Attendance")

(as_date + as_temp) / (as_humid + as_precip)
```


@fig-yearly-wins shows ...

```{r}
#| message: false
#| label: fig-yearly-wins
#| fig-cap: The number of home games at Fenway Park which the Red Sox won plotted against year.

boston_game_weather %>%
  group_by(year) %>%
  summarise(wins_by_year=sum(wl_binary)) %>%
  ggplot(aes(x=year,y=wins_by_year)) + 
  geom_point(size=2,color="darkgreen") + 
  geom_smooth(color="#512d6d",fill="lightblue") + 
  labs(x="Year",y="Number of Wins")
```

## Models



## Model Results



## Conclusions



## References

::: {#refs}
:::


:::{.callout-tip collapse="true"}
## Expand for Session Info
```{r}
#| echo: false


library(sessioninfo)
# save the session info as an object
pkg_sesh <- session_info(pkgs = "attached")

# get the quarto version
quarto_version <- system("quarto --version", intern = TRUE)

# inject the quarto info
pkg_sesh$platform$quarto <- paste(
  system("quarto --version", intern = TRUE), 
  "@", 
  quarto::quarto_path()
  )

# print it out
pkg_sesh
```

:::